IRR (Iterative Refinement Reasoning) Flowchart
========================================================

                    ┌─────────────────┐
                    │ Load Captions   │
                    │ (Group A/B +    │
                    │  Query)         │
                    └─────┬───────────┘
                          │
                          v
                    ┌─────────────────┐
                    │ Stage 1:        │
                    │ Initial Feature │
                    │ Identification  │
                    │ + Confidence    │
                    └─────┬───────────┘
                          │
                          v
    ┌─────────────────────────────────────────────────────┐
    │              FEATURE REFINEMENT LOOP                │
    │                                                     │
    │    ┌─────────────────┐                             │
    │    │ Stage 2:        │                             │
    │    │ Feature         │                             │
    │    │ Self-Validation │                             │
    │    │ & Refinement    │                             │
    │    └─────┬───────────┘                             │
    │          │                                         │
    │          v                                         │
    │    ┌─────────────────┐    No   ┌─────────────────┐ │
    │    │ Feature         │◄────────┤ Max Feature     │ │
    │    │ Confidence >    │         │ Iterations (3)  │ │
    │    │ Threshold?      │         │ Reached?        │ │
    │    └─────┬─────────┬─┘         └─────────────────┘ │
    │          │ Yes     │ No                            │
    │          │         v                               │
    │          │   ┌─────────────────┐                   │
    │          │   │ Stage 3:        │                   │
    │          │   │ Feature         │                   │
    │          │   │ Re-analysis     │                   │
    │          │   └─────┬───────────┘                   │
    │          │         │                               │
    │          │         └───────────────────────────────┘
    │          │
    └──────────┼─────────────────────────────────────────
               v
         ┌─────────────────┐
         │ Stage 4:        │
         │ Initial Query   │
         │ Classification  │
         │ + Confidence    │
         └─────┬───────────┘
               │
               v
    ┌─────────────────────────────────────────────────────┐
    │         CLASSIFICATION REFINEMENT LOOP              │
    │                                                     │
    │    ┌─────────────────┐                             │
    │    │ Stage 5:        │                             │
    │    │ Classification  │                             │
    │    │ Self-Validation │                             │
    │    │ & Critical      │                             │
    │    │ Re-examination  │                             │
    │    └─────┬───────────┘                             │
    │          │                                         │
    │          v                                         │
    │    ┌─────────────────┐    No   ┌─────────────────┐ │
    │    │ Classification  │◄────────┤ Max Classify    │ │
    │    │ Confidence >    │         │ Iterations (3)  │ │
    │    │ Threshold?      │         │ Reached?        │ │
    │    └─────┬─────────┬─┘         └─────────────────┘ │
    │          │ Yes     │ No                            │
    │          │         v                               │
    │          │   ┌─────────────────┐                   │
    │          │   │ Stage 6:        │                   │
    │          │   │ Classification  │                   │
    │          │   │ Refinement      │                   │
    │          │   └─────┬───────────┘                   │
    │          │         │                               │
    │          │         └───────────────────────────────┘
    │          │
    └──────────┼─────────────────────────────────────────
               v
         ┌─────────────────┐
         │ Final Answer    │
         │ with Dual       │
         │ Confidence      │
         │ Scores          │
         └─────────────────┘

Key Stages Explained:
====================

Stage 1: Initial Feature Identification
- Analyze group_a vs group_b captions
- Identify distinguishing pattern
- Rate confidence (0.0-1.0)

Stage 2: Feature Self-Validation 
- Critical questions: "Does this feature work for ALL examples?"
- Look for counterexamples
- Refine feature if needed

Stage 3: Feature Re-analysis
- Continue refinement if confidence < threshold
- Maximum 3 iterations to avoid infinite loops

Stage 4: Initial Query Classification
- Apply validated feature to query
- Classify as group_a or group_b
- Rate classification confidence

Stage 5: Classification Self-Validation
- Critical questions: "Is this the EXACT same behavior?"
- "Could this be similar but different?"
- "Am I being too broad in applying the feature?"

Stage 6: Classification Refinement
- Refine classification based on validation
- Maximum 3 iterations for classification too

Final Output:
============
- Feature Confidence: How sure about the distinguishing pattern
- Classification Confidence: How sure about applying it to query
- Detailed iteration history for both loops
- Final classification with comprehensive reasoning

Critical Self-Questions Asked:
============================

Feature Validation:
- "Does this feature actually distinguish ALL group_a from group_b?"
- "Can I find counterexamples in my analysis?"
- "Are there better distinguishing features I missed?"

Classification Validation:
- "Does the query show the EXACT same type of behavior as group_a?"
- "Could this be a similar but fundamentally different activity?"
- "Are you being too broad or too narrow in applying the feature?"
- "Look for subtle differences that might change the classification"

Example Flow for 0753_B (Animals Running):
=========================================
1. Feature ID: "High-speed locomotion with motion blur" 
2. Feature Validation: 3 iterations → 92% confidence 
3. Initial Classification: "Leaping = locomotion" → group_a ❌
4. Classification Validation: 3 iterations → Still group_a (90% confidence) ❌
5. Result: Wrong but highly confident (shows limitation of iteration)

The dual-iteration approach catches uncertainty better than single-pass,
but some systematic errors persist even with self-questioning.